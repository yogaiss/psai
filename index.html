<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebGIS PSAI 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-measure/dist/leaflet-measure.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
  </style>
</head>
<body>
<div id="map"></div>

<!-- JS Library -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-measure/dist/leaflet-measure.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
<script src="https://unpkg.com/leaflet-minimap/dist/Control.MiniMap.min.js"></script>

<script>
const map = L.map('map', {
  center: [-2.5, 117],
  zoom: 5,
  fullscreenControl: true
});

// Basemaps
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors',
  errorTileUrl: 'https://tile.openstreetmap.org/0/0/0.png'
}).addTo(map);

const satellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  attribution: 'Google Satellite',
  maxZoom: 20,
  errorTileUrl: 'https://tile.openstreetmap.org/0/0/0.png'
});

const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
  attribution: '© Esri, Earthstar Geographics',
  errorTileUrl: 'https://tile.openstreetmap.org/0/0/0.png'
});

const baseLayers = {
  "OpenStreetMap": osm,
  "Google Satellite": satellite,
  "ESRI World Imagery": esri
};

// Overlay GeoJSON
const overlayLayers = {};
const geojsonLayers = [
  {
    name: "Sesar Aktif 2017",
    file: "SesarAktifPuSGeN2017_9.JSON",
    color: "red",
    dash: ""
  },
  {
    name: "Sesar Terindikasi Aktif",
    file: "SesarTerindikasiAktif_8.JSON",
    color: "orange",
    dash: "4,4"
  },
  {
    name: "Megathrust",
    file: "MegathrustPuSGeN2017_7.JSON",
    color: "blue",
    dash: "2,6"
  }
];

function createPopup(feature) {
  let html = '<table>';
  for (let key in feature.properties) {
    html += `<tr><th>${key}</th><td>${feature.properties[key]}</td></tr>`;
  }
  html += '</table>';
  return html;
}

// Load GeoJSON Layers
let loaded = 0;
geojsonLayers.forEach((layer, idx) => {
  const geojson = L.geoJSON(null, {
    style: {
      color: layer.color,
      weight: 2,
      dashArray: layer.dash
    },
    onEachFeature: (feature, layerObj) => {
      layerObj.bindPopup(createPopup(feature));
    }
  });

  fetch(layer.file)
    .then(res => res.json())
    .then(data => {
      geojson.addData(data);
      overlayLayers[layer.name] = geojson;
      map.addLayer(geojson);

      if (idx === 0) {
        setTimeout(() => {
          map.fitBounds(geojson.getBounds());
        }, 300);
      }

      loaded++;
      if (loaded === geojsonLayers.length) {
        L.control.layers(baseLayers, overlayLayers).addTo(map);
        
        // MiniMap setelah semua layer
        const miniMap = new L.Control.MiniMap(osm, { toggleDisplay: true, minimized: false }).addTo(map);
      }
    })
    .catch(err => {
      console.error(`Gagal memuat ${layer.file}`, err);
    });
});

// Plugins
L.Control.geocoder().addTo(map);
L.control.measure({ primaryLengthUnit: 'kilometers' }).addTo(map);
L.control.fullscreen().addTo(map);

// Koordinat mouse
map.on('mousemove', function (e) {
  document.getElementById('mousepos')?.remove();
  const div = document.createElement('div');
  div.id = 'mousepos';
  div.style = 'position:fixed; bottom:5px; left:10px; background:#fff; padding:4px 8px; border-radius:5px; font-size:12px; box-shadow:0 0 4px rgba(0,0,0,0.3)';
  div.innerText = `Lat: ${e.latlng.lat.toFixed(4)}, Lng: ${e.latlng.lng.toFixed(4)}`;
  document.body.appendChild(div);
});
</script>
</body>
</html>
